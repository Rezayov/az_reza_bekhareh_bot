# «از رضا بخر» — بازارچهٔ کُد غذا

این مخزن شامل ربات تلگرامی «از رضا بخر» است که با پایتون ۳ و کتابخانهٔ [aiogram v3](https://docs.aiogram.dev/) پیاده‌سازی شده. فلسفهٔ ربات ساده است: «تو می‌تونی غذا رو از رضا بخری»؛ کاربران می‌توانند کُد غذای خود را بفروشند یا کدهای دیگران را خریداری کنند و تمام فرایند ثبت‌نام، رزرو، پرداخت، تأیید ادمین و امتیازدهی را درون تلگرام انجام دهند.

## قابلیت‌ها
- ثبت‌نام سریع کاربران با شناسهٔ تلگرام، ایمیل اختیاری و تأیید ساختگی OTP.
- مدیریت آگهی‌های فروش کُد غذا با رمزنگاری Fernet و نمایش امن masked code.
- رزرو، آپلود رسید پرداخت، صف بررسی ادمین و تحویل خودکار کُد پس از تأیید.
- محدودیت رزرو همزمان، محدودیت آگهی فعال روزانه و میان‌بری برای حساب‌های فروشنده.
- امتیازدهی دوطرفه، مدیریت اختلاف‌ها و گزارش‌گیری روزانه.
- پنل کامل ادمین داخل تلگرام برای تأیید پرداخت، تغییر تنظیمات، بن/آن‌بن کاربران و مشاهدهٔ آمار.
- زمان‌بندی با APScheduler برای انقضای رزروها، آگهی‌ها و هشدار نزدیک انقضا.

## پیش‌نیازها
- Python 3.11+
- SQLite (پیش‌فرض) یا هر دیتابیس سازگار با SQLAlchemy (قابل تنظیم)
- حساب تلگرام و توکن بات از [@BotFather](https://t.me/BotFather)

## راه‌اندازی سریع (Polling)
1. مخزن را کلون کن و وارد پوشه شو.
2. یک virtualenv بساز و فعال کن:
   ```bash
   python -m venv .venv
   source .venv/bin/activate
   ```
3. وابستگی‌ها را نصب کن:
   ```bash
   pip install -r requirements.txt
   ```
4. فایل `.env` را بر اساس `.env.example` بساز. برای تولید کلید Fernet از دستور زیر استفاده کن:
   ```bash
   python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
   ```
   مقدار خروجی را در متغیر `FERNET_KEY` قرار بده.
5. اسکریپت اصلی را اجرا کن:
   ```bash
   python -m az_reza_bekhareh_bot.app
   ```
   با اجرای فایل، ربات به صورت Polling بالا می‌آید و بات آمادهٔ کار است.

## راه‌اندازی Webhook با FastAPI (اختیاری)
1. در `.env` مقدار `WEBHOOK_URL` را روی آدرس HTTPS عمومی خود قرار بده.
2. داخل اپلیکیشن پایتون از تابع `create_fastapi_app` استفاده کن و با uvicorn اجرا کن:
   ```python
   from az_reza_bekhareh_bot.app import build_dispatcher, create_fastapi_app
   from aiogram import Bot
   from aiogram.enums import ParseMode
   from az_reza_bekhareh_bot.config import settings

   bot = Bot(token=settings.bot_token, parse_mode=ParseMode.HTML)
   dp = build_dispatcher()
   app = create_fastapi_app(bot, dp)
   ```
   سپس:
   ```bash
   uvicorn my_module:app --host 0.0.0.0 --port 8080
   ```
3. در صورت نیاز، مسیر `/webhook` را در تنظیمات بات به BotFather اعلام کن.

## معماری و ماژول‌ها
```
az_reza_bekhareh_bot/
├─ app.py                # نقطهٔ ورود برنامه، ساخت Dispatcher، Scheduler و راه‌اندازی Polling/Webhook
├─ config.py             # مدیریت تنظیمات با Pydantic و خواندن از ENV
├─ crypto.py             # رمزنگاری Fernet برای کُدهای غذا
├─ db.py                 # اتصال Async SQLite و Session manager
├─ models.py             # مدل‌های SQLAlchemy و ایندکس‌ها
├─ middlewares/
│  └─ throttling.py      # محدودسازی نرخ پیام کاربران
├─ keyboards/            # کیبوردهای Inline و Reply
├─ handlers/             # هندلرهای دستورات و فلوهای FSM
├─ services/             # لایهٔ سرویس برای منطق رزرو، پرداخت، گزارش و ...
├─ scheduler/            # جاب‌های زمان‌بندی شده برای انقضا و هشدار
├─ messages/fa.py        # تمام پیام‌ها و متن‌های فارسی برندسازی شده
├─ tests/                # تست‌های واحد و جریان کامل با pytest-asyncio
├─ requirements.txt      # وابستگی‌های پروژه
└─ .env.example          # نمونهٔ تنظیمات محیطی
```

## نقش‌ها
- **کاربر عادی**: ثبت‌نام، فروش، خرید، رزرو، آپلود رسید، امتیازدهی، ثبت اختلاف.
- **حساب فروشنده (seller_account)**: مشابه کاربر عادی اما با رصد ویژه در گزارش‌ها.
- **ادمین**: دسترسی به /admin و دستورات مدیریتی (`/ban`, `/unban`, `/set_ttl`, ...).

## قوانین و حریم خصوصی
- انتقال کُد ممکن است خلاف مقررات دانشگاه باشد؛ مسئولیت کامل با کاربر است.
- اطلاعات ذخیره‌شده فقط شامل شناسهٔ تلگرام، نام، دانشگاه، ایمیل اختیاری، آگهی‌ها و تراکنش‌هاست.
- کُدهای غذا با Fernet رمزگذاری می‌شوند و فقط پس از تأیید ادمین به خریدار نمایش داده می‌شوند.
- هیچ‌گاه به سامانهٔ دانشگاه لاگین نمی‌کنیم و رمز/کوکی درخواست نمی‌شود.

## تست‌ها
برای اجرای تست‌ها:
```bash
pytest
```
تست‌ها شامل موارد زیرند:
- اطمینان از رمزنگاری صحیح کُدها و جلوگیری از رزروهای موازی.
- فلو کامل فروش → رزرو → پرداخت → تأیید → امتیاز.
- مدیریت انقضای رزرو و سناریوی رد پرداخت.
- سرویس‌های سطح پایین مانند آمار، اختلاف، و محدودیت‌ها.

## مقیاس‌پذیری و حساب‌های فروش متعدد
- مدل `users` دارای فیلد `is_seller_account` است تا حساب‌های فروشندهٔ متعدد بدون هاردکد مدیریت شوند.
- گزارش‌های روزانه در `report_service` فروش به تفکیک `seller_id` را فراهم می‌کنند؛ می‌توان برای مانیتورینگ خارجی روشن کرد.
- برای مهاجرت به PostgreSQL یا دیتابیس‌های دیگر، کافی است `DATABASE_URL` را تغییر دهی؛ SQLAlchemy و aiosqlite جایگزین‌پذیر هستند.
- Scheduler مستقل از Polling است و می‌تواند روی workers جداگانه اجرا شود.

## اسکریپت اجرا
- اجرای عادی: `python -m az_reza_bekhareh_bot.app`
- اجرای وبهوک: `uvicorn your_module:app --host 0.0.0.0 --port 8080`

## مجوز
این پروژه صرفاً برای اهداف آموزشی طراحی شده و مسئولیت استفادهٔ واقعی با کاربر است.
